{% extends "base.html" %} {# Assumes base.html uses Tailwind #}
{% block title %}IM Team Club Player Checker{% endblock %}

{% block head %}
{{ super() }}
<style>
  /* Custom styles if needed, but prefer Tailwind utilities */
  /* Style for the file chips generated by JS */
  .file-chip {
    @apply inline-flex items-center bg-gray-200 rounded-full px-3 py-1 text-sm font-medium text-gray-800; /* Removed margin, handled by gap */
  }
  .file-chip select {
    @apply ml-2 border-none bg-transparent text-xs focus:ring-0 focus:outline-none min-w-[8rem];
  }
  .file-chip input[type="text"] {
      @apply ml-1 p-1 border border-gray-300 rounded text-xs;
      display: none; /* Initially hidden */
  }
  .file-chip .remove {
    /* Make 'x' bolder and red on hover */
    @apply ml-2 font-bold text-lg leading-none text-gray-500 hover:text-red-600 cursor-pointer transition-colors duration-150;
  }
  /* Ensure select list takes available height */
  #existing_rosters {
      height: 300px; /* Adjust as needed, or use Tailwind height classes */
  }
</style>
{% endblock %} {# Closes head block #}

{% block content %}
<div class="bg-white shadow sm:rounded-lg border border-gray-200">
  <div class="px-4 py-5 sm:px-6 border-b border-gray-200">
    <h1 class="text-xl leading-6 font-semibold text-gray-900">
      IM Team Club Player Eligibility Checker
    </h1>
    <p class="mt-1 max-w-2xl text-sm text-gray-500">
      Configure rules, upload rosters, and check for violations.
    </p>
  </div>

  <div class="px-4 py-5 sm:p-6">
    {# Display general flashed messages #}
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="mb-6 space-y-2"> {# Added bottom margin #}
            {% for category, message in messages %}
              {% set alert_color = 'blue' if category == 'info' else ('green' if category == 'success' else ('yellow' if category == 'warning' else ('red' if category == 'danger' else 'gray'))) %}
              <div class="rounded-md border border-{{ alert_color }}-300 bg-{{ alert_color }}-50 p-4 shadow-sm" role="alert">
                <div class="flex">
                  <div class="flex-shrink-0">
                     {# Icon omitted for brevity, add if desired like in base.html #}
                  </div>
                  <div class="ml-3">
                    <p class="text-sm font-medium text-{{ alert_color }}-800">{{ message }}</p>
                  </div>
                </div>
              </div>
            {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    {# Main form area with two-column layout on medium screens+ #}
    <form method="post" enctype="multipart/form-data" id="main-form">
        <div class="md:grid md:grid-cols-2 md:gap-x-8 lg:gap-x-16"> {# Two columns on medium+, gap between #}

            {# --- Left Column: Rules & Uploads --- #}
            <div class="space-y-6 flex flex-col"> {# Use flex-col for structure #}

                {# --- Sport Rules Configuration --- #}
                <fieldset class="pb-6"> {# Padding bottom for separation #}
                    <legend class="text-base font-medium text-gray-900 mb-4">Sport Rules Configuration</legend>
                    <div>
                      <label for="player_limit" class="block text-sm font-medium text-gray-700 mb-1">Players on field at one time?</label>
                      <select name="player_limit" id="player_limit" class="mt-1 block w-full max-w-xs rounded-md border-gray-300 py-2 pl-3 pr-10 text-base focus:border-osu-orange focus:outline-none focus:ring-osu-orange sm:text-sm shadow-sm">
                        <option value="5 or fewer">5 or fewer (max 1 club player)</option>
                        <option value="6 or more">6 or more (max 2 club players)</option>
                      </select>
                    </div>
                </fieldset>

                {# --- IM Team Rosters PDF Upload --- #}
                 <fieldset class="py-6 border-t border-gray-200"> {# Added padding and top border #}
                     <legend class="text-base font-medium text-gray-900 mb-4">IM Team Rosters</legend>
                     <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Upload IM Team Rosters PDF:</label>
                       {# Button to trigger file input #}
                      <button type="button" id="add-pdf-btn" class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-osu-orange mb-2">
                         <svg class="-ml-0.5 mr-2 h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                        Add PDF File
                      </button>
                       {# Hidden file input #}
                      <input type="file" name="im_pdf" id="im_pdf" accept=".pdf" required class="hidden">
                       {# Area where JS will add file chips #}
                      <div id="pdf-list" class="mt-2 min-h-[60px] p-4 border border-dashed border-gray-300 rounded-md bg-gray-100 flex flex-wrap gap-2 items-center">
                           {# JS adds chip here #}
                           <span class="text-xs text-gray-500 italic">Selected PDF roster will appear here...</span>
                      </div>
                    </div>
                </fieldset>

                 {# --- Club Rosters CSV Upload --- #}
                 <fieldset class="py-6 border-t border-gray-200"> {# Added padding and top border #}
                    <legend class="text-base font-medium text-gray-900 mb-4">New Club Rosters</legend>
                    <div>
                      <label class="block text-sm font-medium text-gray-700 mb-1">Add new club roster CSV(s):</label>
                      {# Button to trigger file input #}
                      <button type="button" id="add-csv-btn" class="inline-flex items-center px-3 py-1.5 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-osu-orange mb-2">
                        <svg class="-ml-0.5 mr-2 h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-11a1 1 0 10-2 0v2H7a1 1 0 100 2h2v2a1 1 0 102 0v-2h2a1 1 0 100-2h-2V7z" clip-rule="evenodd" /></svg>
                        Add CSV File
                      </button>
                      {# Hidden file input #}
                      <input type="file" name="club_csvs" id="club_csvs" multiple accept=".csv" class="hidden">
                      {# Area where JS will add file chips - ADDED flex flex-wrap gap-2 #}
                      <div id="csv-list" class="mt-2 min-h-[60px] p-4 border border-dashed border-gray-300 rounded-md bg-gray-100 flex flex-wrap gap-2 items-center">
                          {# JS adds chips here #}
                          <span class="text-xs text-gray-500 italic">Selected club rosters will appear here...</span>
                      </div>
                    </div>
                </fieldset>
            </div>

            {# --- Right Column: Saved Rosters --- #}
            <div class="mt-6 md:mt-0 flex flex-col"> {# Add margin top on mobile, none on medium+ #}
                <fieldset class="flex-grow flex flex-col"> {# Allow fieldset to grow #}
                    <legend class="text-base font-medium text-gray-900 mb-4">Use Saved Club Rosters</legend>
                    <div class="flex-grow flex flex-col p-3 border border-gray-300 rounded-md bg-gray-50 shadow-sm">
                      <label for="existing_rosters" class="block text-sm font-medium text-gray-700 mb-1 sr-only">Saved club rosters:</label> {# Screenreader only #}
                          <select multiple id="existing_rosters" class="block w-full flex-grow rounded-md border-gray-300 focus:border-osu-orange focus:ring-osu-orange sm:text-sm"> {# Removed fixed size, added flex-grow #}
                            {% for rid, roster in sorted_rosters %}
                              <option value="{{ rid }}">{{ roster.club_name }} ({{ roster.uploaded_at.split('T')[0] }})</option>
                            {% else %}
                              <option disabled class="text-gray-400">No saved rosters found.</option>
                            {% endfor %}
                          </select>
                          <p class="mt-2 text-xs text-gray-500">Double-click a roster above to add it to the check below (in the CSV list).</p>
                    </div>
                </fieldset>
            </div>

        </div> {# End grid div #}

        {# --- Submit Button --- #}
        <div class="pt-8 mt-8 border-t border-gray-200"> {# Added more padding/margin and top border #}
            <div class="flex justify-end">
              <button type="submit" class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-osu-orange hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-osu-orange">
                Check Eligibility
              </button>
            </div>
        </div>
    </form> {# End form #}
  </div> {# End px/py padding div #}
</div> {# End Card #}
{% endblock %} {# Closes content block #}


{# --- JavaScript (Keep existing logic) --- #}
{% block scripts %}
{{ super() }}
<script>
  // List of clubs for the dropdown
  const CLUBS = ["Archery Club", "Badminton Club", "Baseball Club", "Cycling Club", "Disc Golf Club", "Dodgeball Club", "Equestrain Dressage Club",
  "Equestrian Event", "Equestrian Hunter-Jumper", "Equestrian Polo Club", "Fishing Club", "Gymnastics Club", "Indoor Rock Climbing",
  "Intercollegiate Horse Show Assosiation", "Judo Club", "Karate Club", "Kendo Club", "Marksmanship Club", "Men's Lacrosse Club",
  "Men's Rugby Club", "Men's Soccer Club", "Men's Ultimate Disc Club", "Men's Volleyball Club", "Men's Water Polo Club",
  "Pistol Club", "Racquetball Club", "Rifle Club", "Running Club", "Sailing Club", "Stock Horse Club", "Swim Club", "Table Tennis Club",
  "Tennis Club", "Triathlon Club", "Women's Lacrosse Club", "Women's Rugby Club", "Women's Soccer Club", "Women's Ultimate Disc Club",
  "Women's Volleyball Club", "Women's Water Polo Club","Other"]; // Keep 'Other'

  document.addEventListener('DOMContentLoaded', () => {
    const csvInput = document.getElementById('club_csvs');
    const addCsvBtn = document.getElementById('add-csv-btn');
    const csvList = document.getElementById('csv-list');
    const existingSelect = document.getElementById('existing_rosters');
    const pdfInput = document.getElementById('im_pdf');
    const addPdfBtn = document.getElementById('add-pdf-btn');
    const pdfList = document.getElementById('pdf-list');

    // Clear placeholder text when interaction starts
    const clearPlaceholder = (listElement) => {
        const placeholder = listElement.querySelector('.italic');
        if (placeholder) {
            placeholder.remove();
        }
    };

    // DataTransfer objects to manage file lists for inputs
    const dtCsv = new DataTransfer();
    let pdfDT = new DataTransfer();

    // --- CSV Handling ---
    addCsvBtn.addEventListener('click', () => csvInput.click());
    csvInput.addEventListener('change', () => {
      clearPlaceholder(csvList);
      [...csvInput.files].forEach(f => {
        // Prevent duplicates
        if ([...dtCsv.files].some(existingFile => existingFile.name === f.name && existingFile.size === f.size)) {
          return;
        }
        dtCsv.items.add(f);
        renderCsvChip(f); // Create visual chip
      });
      csvInput.files = dtCsv.files; // Update the actual input's file list
      // csvInput.value = ''; // Clear the input visually (optional, browser dependent)
    });

    // --- Saved Roster Handling ---
    existingSelect.addEventListener('dblclick', e => {
      const option = e.target;
      if (!option.selected || option.disabled) return; // Don't add if already added

      clearPlaceholder(csvList); // Add chip to the CSV list area
      option.disabled = true; // Disable option to prevent re-adding

      const chip = document.createElement('span');
      // Use Tailwind classes defined in <style> or head
      chip.className = 'file-chip'; // This applies the style from the <style> block
      chip.textContent = option.textContent; // e.g., "Club Name (YYYY-MM-DD)"
      chip.dataset.savedRosterId = option.value;

      // Hidden input to submit the selected saved roster ID
      const hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.name = 'existing_rosters'; // Matches Flask route expectation
      hidden.value = option.value;
      chip.appendChild(hidden);

      // Remove button for the chip
      const remove = document.createElement('span');
      remove.className = 'remove'; // This applies the style from the <style> block
      remove.innerHTML = '&times;'; // 'x' symbol
      remove.onclick = () => {
          chip.remove();
          option.disabled = false; // Re-enable the option in the select list
           // Show placeholder if list becomes empty
           if (csvList.children.length === 0) {
               csvList.innerHTML = '<span class="text-xs text-gray-500 italic">Selected club rosters will appear here...</span>';
           }
      };
      chip.appendChild(remove);
      csvList.appendChild(chip); // Append chip to the CSV list
    });

    // --- Function to render CSV file chip ---
    function renderCsvChip(file) {
      const chip = document.createElement('span');
      chip.className = 'file-chip'; // Use Tailwind classes from <style>

      // Display filename without extension
      const fileNameSpan = document.createElement('span');
      fileNameSpan.textContent = file.name.replace(/\.csv$/i, '');
      chip.appendChild(fileNameSpan);


      // Dropdown for club selection
      const sel = document.createElement('select');
      sel.className = 'ml-2 border-none bg-transparent text-xs focus:ring-0 focus:outline-none min-w-[8rem]'; // Tailwind classes for select
      sel.name = 'club_names[]'; // Matches Flask expectation
      sel.required = true; // Make selection required

      // Add a default placeholder option
      const placeholderOpt = document.createElement('option');
      placeholderOpt.value = ""; // Empty value
      placeholderOpt.textContent = "-- Select Club --";
      placeholderOpt.disabled = true;
      placeholderOpt.selected = true;
      sel.appendChild(placeholderOpt);


      CLUBS.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        sel.appendChild(opt);
      });
      chip.appendChild(sel);

      // Text input for 'Other' club name
      const otherInput = document.createElement('input');
      otherInput.type = 'text';
      otherInput.placeholder = 'Enter club name';
      otherInput.name = 'club_names[]'; // Use same name, Flask gets the value if 'Other' isn't selected
      otherInput.className = 'ml-1 p-1 border border-gray-300 rounded text-xs'; // Tailwind classes
      otherInput.style.display = 'none'; // Initially hidden
      chip.appendChild(otherInput);


      sel.addEventListener('change', () => {
          if (sel.value === 'Other') {
              otherInput.style.display = 'inline-block';
              otherInput.required = true; // Make required if Other is chosen
              otherInput.name = 'club_names[]'; // Ensure this input's value is submitted
              sel.name = ''; // Disable the select's name submission
          } else {
              otherInput.style.display = 'none';
              otherInput.value = ''; // Clear if not 'Other'
              otherInput.required = false;
              otherInput.name = ''; // Disable this input's name
              sel.name = 'club_names[]'; // Re-enable select's name
          }
      });


      // Remove button for the chip
      const remove = document.createElement('span');
      remove.className = 'remove'; // Use class from <style>
      remove.innerHTML = '&times;';
      remove.onclick = () => {
        // Remove file from DataTransfer
        const newDtCsv = new DataTransfer();
        for (const existingFile of dtCsv.files) {
          if (existingFile.name !== file.name || existingFile.size !== file.size) {
            newDtCsv.items.add(existingFile);
          }
        }
        // Update dtCsv with the new list
        dtCsv.items.clear(); // Clear old items
        for(const f of newDtCsv.files) dtCsv.items.add(f); // Add remaining files


        csvInput.files = dtCsv.files; // Update input's file list
        chip.remove(); // Remove visual chip
         // Show placeholder if list becomes empty
         if (csvList.children.length === 0) {
             csvList.innerHTML = '<span class="text-xs text-gray-500 italic">Selected club rosters will appear here...</span>';
         }
      };
      chip.appendChild(remove);
      csvList.appendChild(chip); // Append chip to CSV list
    }

    // --- PDF Handling ---
    addPdfBtn.addEventListener('click', () => pdfInput.click());
    pdfInput.addEventListener('change', () => {
      if (!pdfInput.files.length) return;
      clearPlaceholder(pdfList);
      const f = pdfInput.files[0];
      pdfDT = new DataTransfer(); // Reset DataTransfer for single file
      pdfDT.items.add(f);
      pdfInput.files = pdfDT.files; // Update input

      pdfList.innerHTML = ''; // Clear previous PDF chip if any
      const chip = document.createElement('span');
      chip.className = 'file-chip'; // Use class from <style>
      chip.textContent = f.name;

      const remove = document.createElement('span');
      remove.className = 'remove'; // Use class from <style>
      remove.innerHTML = '&times;';
      remove.onclick = () => {
        pdfDT = new DataTransfer(); // Clear DataTransfer
        pdfInput.value = ''; // Clear the input visually
        pdfInput.files = pdfDT.files; // Update input's files
        pdfList.innerHTML = '<span class="text-xs text-gray-500 italic">Selected PDF roster will appear here...</span>'; // Show placeholder
      };
      chip.appendChild(remove);
      pdfList.appendChild(chip);
    });

     // --- Form Validation on Submit (Optional but Recommended) ---
     const mainForm = document.getElementById('main-form');
     mainForm.addEventListener('submit', (event) => {
         // Check if PDF is selected
         if (!pdfInput.files || pdfInput.files.length === 0) {
             alert('Please select an IM Team Rosters PDF file.');
             event.preventDefault(); // Stop form submission
             return;
         }

         // Check if at least one club roster (saved or new CSV) is selected
         const savedRostersSelected = document.querySelectorAll('#csv-list input[name="existing_rosters"]').length > 0;
         const newCsvsSelected = dtCsv.files.length > 0;
         if (!savedRostersSelected && !newCsvsSelected) {
              alert('Please add at least one club roster (either saved or a new CSV).');
              event.preventDefault(); // Stop form submission
              return;
         }

         // Check if all new CSVs have a club selected/entered
         const selects = document.querySelectorAll('#csv-list select[name="club_names[]"]');
         const otherInputs = document.querySelectorAll('#csv-list input[type="text"][name="club_names[]"]');
         let clubNameError = false;
         selects.forEach(sel => {
             if (sel.value === "") { // Check if the placeholder is still selected
                 alert(`Please select a club for the CSV file: ${sel.previousSibling.textContent}`);
                 sel.classList.add('border-red-500'); // Highlight error
                 clubNameError = true;
             } else {
                  sel.classList.remove('border-red-500');
             }
         });
         otherInputs.forEach(input => {
            if (input.style.display !== 'none' && input.value.trim() === "") {
                 alert(`Please enter a club name for the CSV file: ${input.previousSibling.previousSibling.textContent}`);
                 input.classList.add('border-red-500'); // Highlight error
                 clubNameError = true;
            } else {
                 input.classList.remove('border-red-500');
            }
         });

         if (clubNameError) {
             event.preventDefault(); // Stop form submission
             return;
         }

         // Add more checks if needed
     });

  });
</script>
{% endblock %} {# Closes scripts block #}