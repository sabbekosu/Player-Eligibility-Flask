{# templates/sports_clubs/foundation_reconciliation.html #}
{% extends "base.html" %}
{% block title %}Foundation Reconciliation{% endblock %}

{% block content %}
<div class="space-y-8">

  {# --- Page Header --- #}
  <div>
    <h1 class="text-2xl font-semibold text-gray-900">Sports Club Foundation Reconciliation</h1>
    <p class="mt-1 text-sm text-gray-600">
      Upload the latest DRS FS Report, Donor Report, and the current Foundation Summary Excel file.
      The application will add new transactions to the summary file, save unmatched items for review, and update the database history.
    </p>
  </div>

  {# --- Flash Messages Area --- #}
  {# Handled globally in base.html, flash messages will appear here after redirect #}

  {# --- Current Needs Review Count --- #}
  <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 mb-6 rounded-md">
    <div class="flex">
      <div class="flex-shrink-0">
        <svg class="h-5 w-5 text-yellow-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
          <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 3.011-1.742 3.011H4.42c-1.53 0-2.493-1.677-1.743-3.011l5.58-9.92zM10 13a1 1 0 110-2 1 1 0 010 2zm-1-4a1 1 0 011-1h.008a1 1 0 110 2H10a1 1 0 01-1-1z" clip-rule="evenodd" />
        </svg>
      </div>
      <div class="ml-3">
        <p class="text-sm text-yellow-700">
          There are currently <strong class="font-semibold">{{ needs_review_count }}</strong> transaction(s) in the database marked as needing review.
          {# Only show the link if there are items to review #}
          {% if needs_review_count > 0 %}
          <a href="{{ url_for('sports_clubs.foundation_review') }}" class="font-medium underline text-yellow-700 hover:text-yellow-600 ml-2">
            Go to Review Page &rarr;
          </a>
          {% endif %}
        </p>
      </div>
    </div>
  </div>


  {# --- Upload Form --- #}
  <form method="post" enctype="multipart/form-data" class="space-y-6 bg-white p-6 shadow sm:rounded-lg border border-gray-200">
    <fieldset>
      <legend class="text-lg font-medium text-gray-900 mb-4">Upload Reports to Generate Updated Summary</legend>
      {# DRS Report Upload #}
      <div>
        <label for="drs_report" class="block text-sm font-medium text-gray-700 mb-1">1. DRS FS Report (.xlsx)<span class="text-red-600">*</span></label>
        <input type="file" name="drs_report" id="drs_report" required class="block w-full text-sm text-gray-500 border border-gray-300 rounded-md shadow-sm cursor-pointer focus:outline-none focus:ring-osu-orange focus:border-osu-orange file:mr-4 file:py-2 file:px-4 file:rounded-l-md file:border-0 file:text-sm file:font-semibold file:bg-osu-orange file:text-white hover:file:bg-orange-700" accept=".xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
        <p class="mt-1 text-xs text-gray-500">The report containing transaction amounts (debits/credits).</p>
      </div>
      {# Donor Report Upload #}
      <div class="mt-4">
        <label for="donor_report" class="block text-sm font-medium text-gray-700 mb-1">2. Donor Report (.xlsx)<span class="text-red-600">*</span></label>
        <input type="file" name="donor_report" id="donor_report" required class="block w-full text-sm text-gray-500 border border-gray-300 rounded-md shadow-sm cursor-pointer focus:outline-none focus:ring-osu-orange focus:border-osu-orange file:mr-4 file:py-2 file:px-4 file:rounded-l-md file:border-0 file:text-sm file:font-semibold file:bg-osu-orange file:text-white hover:file:bg-orange-700" accept=".xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
        <p class="mt-1 text-xs text-gray-500">The report containing designation descriptions and donor info.</p>
      </div>
      {# Foundation Summary Upload #}
      <div class="mt-4">
        <label for="summary_file" class="block text-sm font-medium text-gray-700 mb-1">3. Current Foundation Summary File (.xlsx)<span class="text-red-600">*</span></label>
        <input type="file" name="summary_file" id="summary_file" required class="block w-full text-sm text-gray-500 border border-gray-300 rounded-md shadow-sm cursor-pointer focus:outline-none focus:ring-osu-orange focus:border-osu-orange file:mr-4 file:py-2 file:px-4 file:rounded-l-md file:border-0 file:text-sm file:font-semibold file:bg-osu-orange file:text-white hover:file:bg-orange-700" accept=".xlsx, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet">
        <p class="mt-1 text-xs text-gray-500">Upload the existing summary file to be updated.</p>
      </div>
    </fieldset>
    {# Submit Button #}
    <div class="pt-5 mt-6 border-t border-gray-200">
      <div class="flex justify-end">
        <button type="submit" class="ml-3 inline-flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
          Upload & Process Files
        </button>
      </div>
    </div>
  </form>

  {# --- Section to Show After Processing --- #}
  {# This block is only rendered if processing_complete is True (set in the GET route after a POST) #}
  {% if processing_complete %}
  <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mt-8 rounded-md" role="alert">
     <div class="flex">
       <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-blue-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
          </svg>
       </div>
       <div class="ml-3">
         <h3 class="text-sm font-medium text-blue-800">Processing Complete</h3>
         <div class="mt-2 text-sm text-blue-700 space-y-1">
           {# Display results from the last processing run #}
           {% if last_results %}
             <p>Added {{ last_results.get('processed', 0) }} new transaction(s) to the summary sheets.</p>
             {% if last_results.get('duplicates_sheet', 0) > 0 %}<p>Skipped {{ last_results.get('duplicates_sheet', 0) }} duplicate(s) already present in sheets.</p>{% endif %}
             {% if last_results.get('skipped_date_range', 0) > 0 %}<p>Skipped {{ last_results.get('skipped_date_range', 0) }} DRS rows outside Donor date range.</p>{% endif %}
             {% if last_results.get('needs_review', 0) > 0 %}
               <p class="font-semibold">Added {{ last_results.get('needs_review', 0) }} transaction(s) to the 'Needs Review' sheet.</p>
             {% endif %}
           {% else %}
             <p>Processing finished, but no detailed results were stored in session.</p>
           {% endif %}
         </div>
         {# Action Buttons #}
         <div class="mt-4">
           <div class="-mx-2 -my-1.5 flex flex-wrap gap-4">
             {# Download Button - Only show if a buffer is available #}
             {% if download_available %}
               <a href="{{ url_for('sports_clubs.download_last_summary') }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500">
                  <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                    <path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" />
                  </svg>
                 Download Updated Summary
               </a>
             {% else %}
                {# Optionally show a disabled state or hide completely #}
                <span class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-400 bg-gray-100 cursor-not-allowed" title="No file generated or available">
                    <svg class="-ml-1 mr-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                    Download Unavailable
                </span>
             {% endif %}
             {# Review Button - Only show if the *last processing run* added items to review #}
             {% if last_results and last_results.get('needs_review', 0) > 0 %}
               <a href="{{ url_for('sports_clubs.foundation_review') }}" class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-yellow-600 hover:bg-yellow-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-yellow-500">
                 Go to Review Page ({{ last_results.get('needs_review', 0) }})
               </a>
             {% endif %}
           </div>
         </div>
       </div>
     </div>
  </div>
  {% endif %}

</div> {# End main container #}
{% endblock %}